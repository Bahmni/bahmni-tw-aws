---

- name: Spin up proxy instance
  ec2:
   region: "{{aws_region}}"
   aws_access_key:   "{{ aws_access_key }}"
   aws_secret_key:   "{{ aws_secret_key }}"
   image: "{{instance_ami}}"
   instance_type: "{{InstanceType}}"
   tenancy: "{{VpcInstanceTenancy}}"
   key_name: "{{instance_key}}"
   source_dest_check: "{{instance_source_destination_check}}"
   vpc_subnet_id: "{{public_subnet_id}}"
   group_id: "{{sg_tw_proxy_group_id}}"
   instance_tags: "{{ProxyServerTags}}"
   count_tag: "{{ProxyServerTags}}"
   exact_count: "{{ProxyExactCount}}"
   volumes: "{{ InstanceVolumes[0].VolumeSpecifications }}"
   assign_public_ip: yes
   wait: yes
  register: proxy_instance

- set_fact: proxy_instance_fact="{{ proxy_instance.tagged_instances[0] }}"

- name: Add proxy to dynamic host group
  add_host:
    name: proxy_host
    hostname: "{{ proxy_instance_fact.public_ip }}"
    groupname: proxy
    ansible_connection: ssh
    ansible_user: centos

#- name: Wait for proxy SSH to come up
#  wait_for: host={{ proxy_instance_fact.public_dns_name }} port=22 delay=60 timeout=320 state=started
